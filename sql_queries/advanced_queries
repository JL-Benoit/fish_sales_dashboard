-- Calculate the total revenue (sum of prix_total) generated by each commercial. Display the commercial's nom, prenom, and the total revenue, sorted highest to lowest.
SELECT
    c.commercial_id,
    c.prenom,
    c.nom,
    ROUND(SUM(cd.prix_total),2) AS total_revenue
FROM
    commercial AS c
INNER JOIN commande AS cmd ON c.commercial_id = cmd.commercial_id
INNER JOIN commande_detail AS cd ON cmd.commande_id = cd.commande_id 
GROUP BY
    c.prenom,
    c.nom,
    c.commercial_id 
ORDER BY
    total_revenue DESC; 

-- Identify the Top 5 selling sub-categories based on the total quantity (quantite) sold. Display the sub-categorie name and the total quantity.
SELECT 
    s.sous_categorie_id,
    s.sous_categorie,
    SUM(cd.quantite) AS total_quantite,
    ROUND(SUM(cd.prix_total),2) AS total_revenue
FROM sous_categorie AS s
INNER JOIN produit AS p ON p.sous_categorie_id = s.sous_categorie_id
INNER JOIN commande_detail AS cd ON cd.produit_id = p.produit_id
GROUP BY 
    s.sous_categorie_id,
    s.sous_categorie
ORDER BY
    total_quantite DESC;

-- Determine the average discount rate (average of remise) applied across all products sold in the database.
SELECT
    p.produit_id,
    p.nom_produit,
    ROUND(AVG(remise), 3) AS avg_remise
FROM
    commande_detail AS cd
INNER JOIN produit AS p ON p.produit_id = cd.produit_id
GROUP BY    
    p.produit_id,
    p.nom_produit
ORDER BY
    avg_remise DESC;

-- Find the region that generated the highest total sales volume (sum of prix_total).
SELECT
    r.region_id,
    r.region,
    ROUND(SUM(cd.prix_total),2) AS total_revenue
FROM
    region AS r
INNER JOIN commercial AS c ON c.region_id = r.region_id
INNER JOIN commande AS cmd ON c.commercial_id = cmd.commercial_id
INNER JOIN commande_detail AS cd ON cmd.commande_id = cd.commande_id 
GROUP BY
    r.region_id,
    r.region
ORDER BY
    total_revenue DESC; 

-- Calculate the number of unique products purchased by each client. Display the client_id and the product count.
SELECT 
    c.client_id,
    c.code_magasin,
    COUNT(cd.produit_id) AS count_produit
FROM client AS c
INNER JOIN commande AS cmd ON c.client_id = cmd.client_id
INNER JOIN commande_detail AS cd ON cmd.commande_id = cd.commande_id
INNER JOIN produit AS p ON cd.produit_id = p.produit_id
GROUP BY 
    c.client_id,
    c.code_magasin
ORDER BY 
    count_produit DESC;

-- Identify products (produit_id, nom_produit) that have never been ordered (commande_detail table). (Requires LEFT JOIN or NOT EXISTS).
SELECT
    p.produit_id,
    p.nom_produit,
    SUM(cd.quantite)
FROM produit AS p
LEFT JOIN commande_detail AS cd ON p.produit_id = cd.produit_id
GROUP BY
    p.produit_id,
    p.nom_produit
HAVING SUM(cd.quantite) IS NULL
ORDER BY
    p.produit_id;

--For products with a prix greater than 10, calculate the average quantity sold per order item (commande_detail).
SELECT  
    cd.produit_id,
    p.nom_produit,
    cd.prix_unitaire,
    ROUND(AVG(cd.quantite), 2) AS avg_quantite_sold
FROM commande_detail AS cd
INNER JOIN produit AS p ON cd.produit_id = p.produit_id
GROUP BY 
    cd.produit_id,
    p.nom_produit,
    cd.prix_unitaire
HAVING cd.prix_unitaire > 10
ORDER BY
    avg_quantite_sold DESC;

-- Find the commercial who has the lowest average order size (average prix_total per order).
WITH order_totals AS (
    SELECT
        commande_id,
        SUM(prix_total) AS order_total_value
    FROM
        commande_detail
    GROUP BY
        commande_id
)
SELECT
    c.commercial_id,
    c.prenom,
    c.nom,
    ROUND(AVG(ot.order_total_value), 2) AS avg_order_size
FROM
    commercial AS c
INNER JOIN commande AS cmd ON c.commercial_id = cmd.commercial_id
INNER JOIN order_totals AS ot ON cmd.commande_id = ot.commande_id
GROUP BY
    c.commercial_id,
    c.prenom,
    c.nom
ORDER BY
    avg_order_size ASC;

-- List the client_id and their associated code_magasin for all clients whose total spending is above the overall average spending per client.
WITH order_totals AS (
    SELECT
        commande_id,
        SUM(prix_total) AS order_total_value
    FROM
        commande_detail
    GROUP BY
        commande_id
),
client_sales_avg AS (
    SELECT
        c.client_id,
        c.code_magasin,
        AVG(ot.order_total_value) AS client_avg_spending 
    FROM
        client AS c
    INNER JOIN commande AS cmd ON c.client_id = cmd.client_id
    INNER JOIN order_totals AS ot ON cmd.commande_id = ot.commande_id
    GROUP BY
        c.client_id,
        c.code_magasin
)
SELECT
    csa.client_id,
    csa.code_magasin,
    ROUND(csa.client_avg_spending, 2) AS average_spending
FROM
    client_sales_avg AS csa
WHERE
    csa.client_avg_spending > (
        SELECT AVG(client_avg_spending)
        FROM client_sales_avg
    )
ORDER BY
    average_spending DESC;