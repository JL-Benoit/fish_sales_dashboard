-- Calculate three things from the commande_detail table in a single query: 
-- The total number of items sold. 
-- The average price per item sold.
-- The highest price ever paid for a single item.
SELECT 
    SUM(quantite) AS total_sold_items,
    ROUND(AVG(prix_unitaire),3) AS average_item_price,
    MAX(prix_unitaire) AS highest_price
FROM commande_detail;


-- Find the total quantity of products sold for each order.
SELECT
    commande_id,
    SUM(quantite) AS total_quantite_par_commande
FROM commande_detail
GROUP BY commande_id
ORDER BY commande_id;


--Find the produit_id of products that have been sold more than 100 times in total (sum of quantite).
SELECT 
    produit_id,
    SUM(quantite) AS sum_quant
FROM commande_detail
GROUP BY 
    produit_id
HAVING SUM(quantite) > 100
ORDER BY sum_quant DESC;


--Find the commande_id and the total number of distinct products for orders that contain more than 30 different products.
SELECT 
    commande_id,
    COUNT(DISTINCT produit_id) AS distinct_products_bought
FROM commande_detail
GROUP BY commande_id
HAVING COUNT(DISTINCT produit_id) > 30
ORDER BY distinct_products_bought DESC;


--Find the average quantity of products per order, but only for orders that have a total quantity of items greater than 100.
SELECT
    commande_id,
    ROUND(AVG(quantite),2) AS avg_quant
FROM commande_detail
GROUP BY commande_id
HAVING SUM(quantite) > 100
ORDER BY avg_quant DESC;


--  Find the commande_id for orders that have a total quantity of more than 100 units, but ignore any items that were sold in quantities of less than 5.
SELECT
    commande_id,
    SUM(quantite) AS sum_quant
FROM commande_detail
WHERE quantite >= 5
GROUP BY commande_id
HAVING SUM(quantite) > 100
ORDER BY commande_id ASC; 


-- Find the commande_id for orders that span 10 or more unique produit_ids.
SELECT
    commande_id,
    COUNT(DISTINCT produit_id) AS produit_distinct
FROM commande_detail
GROUP BY commande_id
HAVING COUNT(DISTINCT produit_id) > 10
ORDER BY commande_id ASC;


-- For each commande_id, calculate: The total number of rows (lines) in the order - The number of lines where the quantite is 10 or more.
SELECT
    commande_id,
    COUNT(*) AS total_lines,
    SUM(CASE WHEN quantite >= 10 THEN 1 ELSE 0 END) AS num_lines_over_10
FROM commande_detail
GROUP BY commande_id
ORDER BY commande_id ASC;


-- For each order, calculate the percentage of lines that are "Bulk Lines" (where quantite >= 20).
SELECT
    commande_id,
    COUNT(*) AS total_lines,
    ROUND(SUM(CASE WHEN quantite >= 20 THEN 1 ELSE 0 END)* 100.0 / COUNT(*),2) AS percent_over_20
FROM commande_detail
GROUP BY commande_id
HAVING ROUND(SUM(CASE WHEN quantite >= 20 THEN 1 ELSE 0 END)* 100.0 / COUNT(*),2) > 0
ORDER BY commande_id ASC;


--Calculate the sum of total_commande from the commande table joined with the commercial and region tables.
SELECT
    COALESCE(region, 'GLOBAL') AS region_label, 
    COALESCE(nom, '--- Subtotal ---') AS commercial_label,
    SUM(prix_totaL) AS total_sales
FROM commande_detail
LEFT JOIN commande ON commande_detail.commande_id = commande.commande_id
LEFT JOIN commercial ON commande.commercial_id = commercial.commercial_id
LEFT JOIN region ON commercial.region_id = region.region_id
GROUP BY ROLLUP (region, nom);


--Create a report showing total quantity sold by Category, then by Product, with subtotals.
SELECT
    COALESCE(categorie, 'all_categories') AS categorie_label, 
    COALESCE(nom_produit, 'categorie_total') AS produit_label,
    SUM(quantite) AS sum_total
FROM commande_detail AS cd
LEFT JOIN produit AS p ON cd.produit_id = p.produit_id
LEFT JOIN sous_categorie AS sc ON p.sous_categorie_id = sc.sous_categorie_id
LEFT JOIN categorie AS c ON sc.categorie_id = c.categorie_id
GROUP BY ROLLUP (categorie, nom_produit);


-- Modify your previous query to only show the rows that are totals.
SELECT
    COALESCE(categorie, 'all_categories') AS categorie_label, 
    COALESCE(nom_produit, 'categorie_total') AS produit_label,
    SUM(quantite) AS sum_total
FROM commande_detail AS cd
LEFT JOIN produit AS p ON cd.produit_id = p.produit_id
LEFT JOIN sous_categorie AS sc ON p.sous_categorie_id = sc.sous_categorie_id
LEFT JOIN categorie AS c ON sc.categorie_id = c.categorie_id
GROUP BY ROLLUP (categorie, nom_produit)
HAVING GROUPING(nom_produit) = 1;


-- Refine the SELECT part of your query to use CASE WHEN instead of COALESCE.
SELECT
    CASE WHEN GROUPING(categorie) = 1 THEN '!!! GRAND TOTAL !!!' ELSE categorie END AS category_header,
    CASE WHEN GROUPING(categorie) = 1 THEN '---'
         WHEN GROUPING(nom_produit) = 1 THEN 'Category Subtotal'
         ELSE nom_produit 
    END AS item_label,
    SUM(quantite) AS sum_total
FROM commande_detail AS cd
LEFT JOIN produit AS p ON cd.produit_id = p.produit_id
LEFT JOIN sous_categorie AS sc ON p.sous_categorie_id = sc.sous_categorie_id
LEFT JOIN categorie AS c ON sc.categorie_id = c.categorie_id
GROUP BY ROLLUP (categorie, nom_produit);


--Add an ORDER BY clause to your query to ensure perfect report structure.
SELECT
    CASE WHEN GROUPING(categorie) = 1 THEN '!!! GRAND TOTAL !!!' ELSE categorie END AS category_header,
    CASE WHEN GROUPING(categorie) = 1 THEN '-------------'
         WHEN GROUPING(nom_produit) = 1 THEN 'Category Subtotal -------------'
         ELSE nom_produit 
    END AS item_label,
    SUM(quantite) AS sum_total
FROM commande_detail AS cd
LEFT JOIN produit AS p ON cd.produit_id = p.produit_id
LEFT JOIN sous_categorie AS sc ON p.sous_categorie_id = sc.sous_categorie_id
LEFT JOIN categorie AS c ON sc.categorie_id = c.categorie_id
GROUP BY ROLLUP (categorie, nom_produit)
ORDER BY GROUPING(categorie), categorie, GROUPING(nom_produit), nom_produit;


-- Produce a report that lists every category name (categorie) alongside the total revenue generated by that category.
SELECT
    categorie,
    ROUND(COALESCE(SUM(cd.prix_total), 0),2) AS total_revenu
FROM categorie AS c
LEFT JOIN sous_categorie AS sc ON c.categorie_id = sc.categorie_id
LEFT JOIN produit AS p ON sc.sous_categorie_id = p.sous_categorie_id
LEFT JOIN commande_detail AS cd ON p.produit_id = cd.produit_id
GROUP BY categorie
ORDER BY total_revenu DESC;


-- Generate a report that shows each Region Name (region) and two calculated columns:
-- High_Value_Revenue: The sum of prix_total where the prix_unitaire is greater than or equal to 100.
-- Standard_Revenue: The sum of prix_total where the prix_unitaire is less than 100.
SELECT 
    r.region,
    ROUND(COALESCE(SUM(cd.prix_total) FILTER(WHERE cd.prix_unitaire >= 100),0),2)  AS "revenu_de_prix_unitaire >= 100",
    ROUND(COALESCE(SUM(cd.prix_total) FILTER(WHERE cd.prix_unitaire < 100),0),2)  AS "revenu_de_prix_unitaire < 100"
FROM region AS r
LEFT JOIN commercial AS c ON r.region_id = c.region_id
LEFT JOIN commande AS cmd ON c.commercial_id = cmd.commercial_id
LEFT JOIN commande_detail AS cd ON cmd.commande_id = cd.commande_id
GROUP BY r.region;